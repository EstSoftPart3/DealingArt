<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.da.mapper.DealMapper">
	<select id="dealSerach" resultType="hashMap" parameterType="hashMap">
		/*딜 검색*/
		SELECT 
				D.DEAL_SQ AS dealSq, /*거래번호*/
				A.WORK_SQ AS workSq, /*작품번호*/
				A.MBR_SQ AS mbrSq, /*멤버번호*/
				A.ARTST_SQ AS artstSq, /*작가번호*/
				B.AUTH_SQ AS authSq, /*작가구분*/
				A.ARTST_ACTVTY_NM AS artstActvtyNm, /*작가활동명*/
				A.ARTST_ENGLS_NM AS artstEnglsNm, /*작가영문명*/
				IF(C.ARTST_YOD IS NULL OR C.ARTST_YOD = " " ,A.ARTST_BIRTH_YEAR,CONCAT(A.ARTST_BIRTH_YEAR,'~',C.ARTST_YOD)) AS artstBirthYear, /*작가생년월일*//* 작가생년월일+작가사망연도*/
				C.ARTST_PROFILE_IMG_URL AS artstProfileImgUrl, /*작가프로필사진주소*/
				D.DEAL_TYP_CD AS dealTypCd, /*거래유형*/
				D.DEAL_STTS_CD AS dealSttsCd, /*거래상태*/
				A.WORK_NM AS workNm, /*작품명*/
				A.WORK_PRODC_YEAR AS workProdcYear, /*작품제작년도*/
				A.WORK_MATRL AS workMatrl, /*작품소재*/
				IF(A.WORK_MAIN_IMG_URL IS NULL, A.WORK_IMG_FRT_URL, A.WORK_MAIN_IMG_URL) AS workMainImgUrl, /*작품대표이미지주소*/
				A.WORK_SIZE_HEIGHT AS workSizeHeight, /*작품사이즈높이*/
				A.WORK_SIZE_WIDTH AS workSizeWidth, /*작품사이즈가로*/
				A.WORK_SIZE_DEPTH AS workSizeDepth, /*작품사이즈세로*/
				A.WORK_PRODC_YEAR AS workProdcYear, /*작품제작년도*/
				(SELECT FORMAT(MAX(BID_PRC), 0)
				FROM TBL_DA_AUCTN_BID_H
				WHERE D.DEAL_SQ = DEAL_SQ) AS maxBidPrc, /*응찰가*/
				FORMAT(D.DEAL_FINAL_PRC, 0) AS dealFinalPrc, /*거래최종가격*/
				FORMAT(D.DEAL_STRT_PRC, 0) AS dealStrtPrc, /*거래시작가격*/
				FORMAT(D.DEAL_SBID_PRC, 0) AS dealSbidPrc, /*거래낙찰가격*/
				(SELECT COUNT(DEAL_SQ)
				FROM TBL_DA_AUCTN_BID_H 
				WHERE D.DEAL_SQ = DEAL_SQ) AS bidCnt, /*응찰수*/
				DATE_FORMAT(D.DEAL_STRT_DT, '%Y.%m.%d') AS dealStrtDate, /*거래시작일시*/
				DATE_FORMAT(D.DEAL_ENDNG_DT, '%Y.%m.%d') AS dealEndngDate, /*거래종료일시*/
				D.DEAL_ENDNG_DT AS dealEndngDateTime /*거래종료날짜시간*/
		FROM 
				TBL_DA_WORK_M AS A
		INNER JOIN
				TBL_DA_MBR_M AS B
			ON	A.MBR_SQ = B.MBR_SQ
		LEFT JOIN
				TBL_DA_ARTST_M AS C
			ON 	A.ARTST_SQ = C.ARTST_SQ 
		INNER JOIN 
				TBL_DA_DEAL_M AS D
			ON 	A.WORK_SQ = D.WORK_SQ 
		WHERE
				1=1
			<if test="searchKeyword != null and searchKeyword != ''">
				AND 
				(	A.WORK_NM LIKE CONCAT('%',#{searchKeyword},'%')
				OR 	A.ARTST_ACTVTY_NM LIKE CONCAT('%',#{searchKeyword},'%')
				OR 	C.ARTST_ENGLS_NM LIKE CONCAT('%',#{searchKeyword},'%')
				OR 	A.WORK_PRODC_YEAR LIKE CONCAT('%',#{searchKeyword},'%')
				OR 	A.WORK_MATRL LIKE CONCAT('%',#{searchKeyword},'%')
				OR 	A.ARTST_BIRTH_YEAR LIKE CONCAT('%',#{searchKeyword},'%'))
			</if>
			<if test="authSq != null and authSq != ''">
				AND B.AUTH_SQ = #{authSq}
        	</if>	
			<if test="dealTypCds != null">
				AND D.DEAL_TYP_CD IN
				<foreach collection="dealTypCds" item="item" index="idex"  open="(" close=")" separator=",">
		        	#{item}
		        </foreach>
        	</if>
        	<if test="dealSttsCds != null">
				AND D.DEAL_STTS_CD IN
				<foreach collection="dealSttsCds" item="item" index="idex"  open="(" close=")" separator=",">
		        	#{item}
		        </foreach>
        	</if>
			<if test="workShpCds != null">
				AND A.WORK_SHP_CD IN
				<foreach collection="workShpCds" item="item" index="idex"  open="(" close=")" separator=",">
		        	#{item}
		        </foreach>
        	</if>
	        <if test="workClsfcCds != null">
				AND A.WORK_CLSFC_CD IN
				<foreach collection="workClsfcCds" item="item" index="idex"  open="(" close=")" separator=",">
		        	#{item}
		        </foreach>
	        </if>
	        <if test="sort != null and sort != ''">
	        	<if test='sort == "LT"'>
	        		ORDER BY D.DEAL_STRT_DT
	        	</if>
	        	<if test='sort == "PY"'>
	        		ORDER BY A.WORK_PRODC_YEAR
	        	</if>
	        	<if test='sort == "KN"'>
	        		ORDER BY A.ARTST_ACTVTY_NM
	        	</if>
	        	<if test='sort == "EN"'>
	        		ORDER BY C.ARTST_ENGLS_NM
	        	</if>
	        	<if test='sort == "PC"'>
	        		ORDER BY maxBidPrc, dealFinalPrc
	        	</if>
	        	<if test='sort == "RT"'>
	        		ORDER BY D.DEAL_ENDNG_DT
	        	</if>
	        	<if test='type == "DOWN"'>
	        		DESC
	        	</if>
	        	<if test='type == "UP"'>
	        		ASC 
	        	</if>
	        </if>
<!-- 	        LIMIT 6 OFFSET #{startRow} -->
	</select>
	<select id="dealDetail" parameterType="String" resultType="hashMap">
		/*거래상세*/
		SELECT 
				D.DEAL_SQ AS dealSq, /*거래순번*/
				A.WORK_SQ AS workSq, /*작품번호*/
				A.MBR_SQ AS mbrSq, /*멤버번호*/
				A.ARTST_SQ AS artstSq, /*작가번호*/
				D.SELL_MBR_SQ AS sellMbrSq, /*판매자 순번*/
				A.ARTST_ACTVTY_NM AS artstActvtyNm, /*작가활동명*/
				A.ARTST_ENGLS_NM AS artstEnglsNm, /*작가영문명*/
				(SELECT SUB.MBR_NCKNM FROM TBL_DA_MBR_M SUB WHERE SUB.MBR_SQ = A.MBR_SQ) AS mbrNcknm, /*작가 닉네임*/
				YEAR (A.ARTST_BIRTH_YEAR) AS artstBirthYear, /*작가생년월일*/
				C.ARTST_PROFILE_IMG_URL AS artstProfileImgUrl, /*작가프로필사진주소*/
				D.DEAL_TYP_CD AS dealTypCd, /*거래유형*/
				D.DEAL_STTS_CD AS dealSttsCd, /*거래상태*/
				A.WORK_NM AS workNm, /*작품명*/
				A.WORK_PRODC_YEAR AS workProdcYear, /*작품제작년도*/
				IF(A.WORK_MAIN_IMG_URL IS NULL, A.WORK_IMG_FRT_URL, A.WORK_MAIN_IMG_URL) AS workMainImgUrl, /*작품대표이미지주소*/
				A.WORK_SIZE_WIDTH AS workSizeWidth, /*작품사이즈가로*/
				A.WORK_SIZE_DEPTH AS workSizeDepth, /*작품사이즈세로*/
				A.WORK_PRODC_YEAR AS workProdcYear, /*작품제작년도*/
				A.WORK_MATRL AS workMatrl, /*작품소재*/
				A.WORK_GRT_URL AS workGrtUrl, /*작품보증서URL*/
				A.WORK_FRM_YN AS workFrmYn, /*작품액자유무*/
				D.MBR_REF_NO AS mbrRefNo, /*거래주문코드*/
				(SELECT FORMAT(MAX(BID_PRC), 0)
				FROM TBL_DA_AUCTN_BID_H
				WHERE D.DEAL_SQ = DEAL_SQ) AS maxBidPrc, /*응찰가*/
				FORMAT(D.DEAL_STRT_PRC, 0) AS dealStrtPrc, /*거래시작가격*/
				FORMAT(D.DEAL_SBID_PRC, 0) AS dealSbidPrc, /*거래낙찰가격*/
				(SELECT COUNT(DEAL_SQ)
				FROM TBL_DA_AUCTN_BID_H 
				WHERE D.DEAL_SQ = DEAL_SQ) AS bidCnt, /*응찰수*/
				(SELECT MBR_SQ 
				FROM TBL_DA_AUCTN_BID_H
				WHERE D.DEAL_SQ = DEAL_SQ
				ORDER BY BID_DATE DESC LIMIT 1) AS bidMbrSq, /*마지막 응찰 회원 순번*/
				DATE_FORMAT(D.DEAL_STRT_DT, '%Y.%m.%d') AS dealStrtDate, /*거래시작날짜*/
				DATE_FORMAT(D.DEAL_ENDNG_DT, '%Y.%m.%d') AS dealEndngDate, /*거래종료날짜*/
				D.DEAL_ENDNG_DT AS dealEndngDateTime /*거래종료날짜시간*/
		FROM 
				TBL_DA_WORK_M AS A
		LEFT JOIN
				TBL_DA_ARTST_M AS C
			ON 	A.ARTST_SQ = C.ARTST_SQ 
		INNER JOIN 
				TBL_DA_DEAL_M AS D
			ON 	A.WORK_SQ = D.WORK_SQ 
		WHERE 
				A.WORK_SQ = #{workSq}
	</select>
	
	<insert id="dealReg">
		/*거래 등록*/
		INSERT INTO
					TBL_DA_DEAL_M (
						WORK_SQ,
						SELL_MBR_SQ,
						DEAL_TYP_CD,
						DEAL_STTS_CD,
						DEAL_STRT_PRC,
						DEAL_STRT_DT,
						DEAL_ENDNG_DT
						<if test="artstSq != null and artst != ''">
							,ARTST_SQ
						</if>
						<if test="dealFinalPrc != null and dealFinalPrc != ''">
							,DEAL_FINAL_PRC
						</if>
					) VALUES (
						#{workSq},
						#{mbrSq},
						#{dealTypCd},
						#{dealSttsCd},
						#{dealStrtPrc},
						#{dealStrtDt}
						<if test="dealStrtDtAddDt != null and dealStrtDtAddDt != ''">
							<!-- ,DATE_ADD(#{dealStrtDt}, INTERVAL #{dealStrtDtAddDt} DAY) -->
							<![CDATA[
							,DATE_ADD(DATE_FORMAT(#{dealStrtDt},'%Y-%m-%d %H') + INTERVAL
						   	CASE
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  10 THEN 10 
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  20 THEN 20
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  30 THEN 30
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  40 THEN 40
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  50 THEN 50
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <=  59 THEN 00
						   	END MINUTE, INTERVAL #{dealStrtDtAddDt} DAY)
    						]]>
						</if>
						<if test="dealEndngDt != null and dealEndngDt != ''">
							,#{dealEndngDt}
						</if>
						<if test="artstSq != null and artst != ''">
							,#{artstSq}
						</if>
						<if test="dealFinalPrc != null and dealFinalPrc != ''">
							,#{dealFinalPrc}
						</if>
					) 
					ON DUPLICATE KEY UPDATE
					
						WORK_SQ = #{workSq},
						SELL_MBR_SQ = #{mbrSq},
						DEAL_TYP_CD = #{dealTypCd},
						DEAL_STTS_CD = #{dealSttsCd},
						DEAL_STRT_PRC = #{dealStrtPrc},
						DEAL_STRT_DT = #{dealStrtDt}
						<if test="dealStrtDtAddDt != null and dealStrtDtAddDt != ''">
							<![CDATA[
							,DEAL_ENDNG_DT = DATE_ADD(DATE_FORMAT(#{dealStrtDt},'%Y-%m-%d %H') + INTERVAL
						   	CASE
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  10 THEN 10 
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  20 THEN 20
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  30 THEN 30
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  40 THEN 40
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <  50 THEN 50
								WHEN TIME_FORMAT(#{dealStrtDt},'%i') <=  59 THEN 00
						   	END MINUTE, INTERVAL #{dealStrtDtAddDt} DAY)
    						]]>
						</if>
						<if test="dealEndngDt != null and dealEndngDt != ''">
							,DEAL_ENDNG_DT = #{dealEndngDt}
						</if>
						<if test="artstSq != null and artst != ''">
							,ARTST_SQ = #{artstSq}
						</if>
						<if test="dealFinalPrc != null and dealFinalPrc != ''">
							,DEAL_FINAL_PRC = #{dealFinalPrc}
						</if>
	</insert>
	
	<update id="updateMbrRefNo">
		/*거래 등록 주문번호 등록*/
		UPDATE
				TBL_DA_DEAL_M
		SET
				MBR_REF_NO = CONCAT('D', LPAD(DEAL_SQ, 17, '0'))
		WHERE
				DEAL_SQ = LAST_INSERT_ID()
	</update>
	
	<select id="bidRegCheck" resultType="int" parameterType="hashMap">
		/*회원이 입력한 응찰가와 마지막 응찰가와 비교한다.*/
		SELECT 
		    	COUNT(*) 
		FROM
			    (
			    SELECT 
			    		*
			    FROM 
			    		TBL_DA_AUCTN_BID_H 
				WHERE 
						1=1
				    AND MBR_SQ = #{mbrSq}
				    AND DEAL_SQ = #{dealSq}
				    AND BID_PRC >= #{bidPrc}
				    GROUP BY DEAL_SQ
				) A
	</select>
	
	<insert id="bidReg" parameterType="hashMap">
		/*응찰 테이블에 insert한다*/
		INSERT INTO 
		
		TBL_DA_AUCTN_BID_H(
		
			MBR_SQ,
			DEAL_SQ,
			BID_PRC,
			BID_DATE
			
		)VALUES(
		
			#{mbrSq},
			#{dealSq},
			#{bidPrc},
			NOW()
		)
	</insert>
	
	<update id="updateDealAuctnPrc" parameterType="hashMap">
		/* 딜 테이블에 응찰 가격 업데이트*/
		UPDATE
				TBL_DA_DEAL_M
		SET
				DEAL_AUCTN_PRC = #{bidPrc}
		WHERE
				DEAL_SQ = #{dealSq}
	</update>
	
	<select id="selectSuccessfulBidList" resultType="hashMap">
		/*경매 종료 시간 지난 경매 정보 가져오기*/
		SELECT 
				A.DEAL_SQ AS dealSq,
				A.WORK_SQ AS workSq,
				B.WORK_NM AS workNm,
				A.DEAL_TYP_CD AS dealTypCd,
				A.DEAL_AUCTN_PRC AS dealAuctnPrc,
				DATE_FORMAT(A.DEAL_STRT_DT, '%Y.%m.%d %H:%i') AS dealStrtDt,
				DATE_FORMAT(A.DEAL_ENDNG_DT, '%Y.%m.%d %H:%i') AS dealEndngDt
		FROM
				TBL_DA_DEAL_M A
		INNER JOIN 
				TBL_DA_WORK_M B
			ON	A.WORK_SQ = B.WORK_SQ
		WHERE 
				A.DEAL_TYP_CD = 'A'
			AND A.DEAL_STTS_CD = 'TP'
			AND A.DEAL_ENDNG_DT <![CDATA[<=]]> NOW()
	</select>
	
	<select id="selectNotSoldSaleList" resultType="hashMap">
		/*판매 종료 시간 지났지만 판매 되지 않은 정찰가 거래 정보 가져오기*/
		SELECT 
				A.DEAL_SQ AS dealSq,
				A.WORK_SQ AS workSq,
				B.WORK_NM AS workNm,
				A.SELL_MBR_SQ AS sellMbrSq,
				A.DEAL_TYP_CD AS dealTypCd,
				A.DEAL_AUCTN_PRC AS dealAuctnPrc,
				DATE_FORMAT(A.DEAL_STRT_DT, '%Y.%m.%d %H:%i') AS dealStrtDt,
				DATE_FORMAT(A.DEAL_ENDNG_DT, '%Y.%m.%d %H:%i') AS dealEndngDt
		FROM
				TBL_DA_DEAL_M A
		INNER JOIN 
				TBL_DA_WORK_M B
			ON	A.WORK_SQ = B.WORK_SQ
		WHERE 
				A.DEAL_TYP_CD = 'S'
			AND A.DEAL_STTS_CD = 'TP'
			AND A.DEAL_ENDNG_DT <![CDATA[<=]]> NOW()
	</select>
	
	<select id="selectSuccessfulBidBuyMbrSq" resultType="String">
		/*경매 종료된 거래 낙찰자 가져오기*/
		SELECT 
				MBR_SQ AS buyMbrSq
		FROM 
				TBL_DA_AUCTN_BID_H
		WHERE 
				 DEAL_SQ = #{dealSq}
		GROUP BY DEAL_SQ 
		ORDER BY BID_PRC DESC;
	</select>
	
	<update id="updateSuccessfulBidDeal">
		/*경매 종료된 거래 정보 업데이트*/
		UPDATE 
				TBL_DA_DEAL_M
		SET
				DEAL_STTS_CD = 'TC'
				<if test="buyMbrSq != null and buyMbrSq != ''">
					,BUY_MBR_SQ = #{buyMbrSq}
				</if>
				<if test="dealSbidPrc != null and dealSbidPrc != ''">
					,DEAL_SBID_PRC = #{dealSbidPrc}
				</if>
				<if test="dealFinalPrc != null and dealFinalPrc != ''">
					DEAL_FINAL_PRC = #{dealFinalPrc}
				</if>
		WHERE 
				DEAL_SQ = #{dealSq}
	</update>
	
	<select id="workDetail" resultType="hashMap" parameterType="String">
		/*작품 상세 정보 가져오기*/
		SELECT 
				A.WORK_SQ AS workSq,
				A.ARTST_SQ AS artstSq,
				A.MBR_SQ AS mbrSq,
				IF(A.WORK_MAIN_IMG_URL IS NULL, A.WORK_IMG_FRT_URL, A.WORK_MAIN_IMG_URL) AS workMainImgUrl, /*작품대표이미지주소*/
				A.ARTST_ACTVTY_NM AS artstActvtyNm,
				A.WORK_NM AS workNm,
				A.WORK_PRODC_YEAR AS workProdcYear,
				A.WORK_MATRL AS workMatrl,
				A.WORK_FRM_YN AS workFrmYn,
				A.WORK_SIZE_WIDTH AS workSizeWidth,
				A.WORK_SIZE_DEPTH AS workSizeDepth,
				A.WORK_SALE_YN AS workSaleYn,
				A.WORK_CLR_CD AS workClrCd,
				A.ARTST_ENGLS_NM AS artstEnglsNm,
			
				FORMAT(A.WORK_PRC, 0) AS workPrc,
				B.MBR_NCKNM AS mbrNcknm
		FROM
				TBL_DA_WORK_M AS A
		INNER JOIN
				TBL_DA_MBR_M AS B
			ON	A.MBR_SQ = B.MBR_SQ
		WHERE 
				A.WORK_SQ = #{workSq}
	</select>
	<select id="selectAutoBid" resultType="hashMap" parameterType="hashMap">
		/*자동응찰 내용 조회*/
		SELECT
				MBR_SQ AS mbrSq,
				DEAL_SQ AS dealSq,
				AUTO_BID_PRC AS autoBidPrc
		FROM 
				TBL_DA_AUTO_BID_H
		WHERE 
				DEAL_SQ = #{dealSq}
				AND AUTO_BID_PRC <![CDATA[>]]> #{bidPrc}
		ORDER BY AUTO_BID_DT ASC, AUTO_BID_PRC ASC 
	</select>
	<select id="selectMaxAutoBidPrc" resultType="hashMap" parameterType="long">
		/*자동응찰 최고 금액 조회*/
		SELECT
				AUTO_BID_PRC
		FROM 
				TBL_DA_AUTO_BID_H
		WHERE 
				DEAL_SQ = #{dealSq}
				AND AUTO_BID_PRC <![CDATA[>]]> #{bidPrc}
		ORDER BY AUTO_BID_PRC DESC
		LIMIT 1
	</select>
	<insert id="insertAutoBid">
		/*자동응찰 등록*/
		INSERT INTO
					TBL_DA_AUTO_BID_H(
						MBR_SQ,
						DEAL_SQ,
						AUTO_BID_PRC,
						AUTO_BID_DT
					) VALUES (
						#{mbrSq},
						#{dealSq},
						#{autoBidPrc},
						NOW()
					)
	</insert>
	<update id="updateLastBid">
		/*마지막 입찰자 자동응찰 빠른 순으로 변경*/
		UPDATE
				TBL_DA_AUCTN_BID_H
		SET
				MBR_SQ = #{mbrSq}
		WHERE
				DEAL_SQ = #{dealSq}
			AND BID_PRC = #{bidPrc}
	</update>
	<select id="selectAuctnBidList" resultType="hashMap" parameterType="String">
		/* 거래내역 리스트 가져오기 (응찰히스토리)*/
		SELECT 
				BID_PRC AS bidPrc,
				DATE_FORMAT(BID_DATE, '%Y.%m.%d %H:%i:%s') AS bidDate 
		FROM 
				TBL_DA_AUCTN_BID_H
		WHERE 
				DEAL_SQ = #{dealSq}
	</select>
	
	<select id="selectDeal" resultType="hashMap" parameterType="String">
		/* 거래 등록된 정보 가져오기 */
		SELECT 
				DEAL_SQ AS dealSq,
				SELL_MBR_SQ AS sellMbrSq,
				WORK_SQ AS workSq,
				DEAL_TYP_CD AS dealTypCd,
				DEAL_STTS_CD AS dealSttsCd,
				FORMAT(DEAL_STRT_PRC, 0) AS dealStrtPrc,
				DATE_FORMAT(DEAL_STRT_DT, '%Y.%m.%d') AS dealStrtDate,
				DATE_FORMAT(DEAL_ENDNG_DT, '%Y.%m.%d') AS dealEndngDate,
				DATE_FORMAT(DEAL_STRT_DT, '%H:%i') AS dealStrtTime,
				DATE_FORMAT(DEAL_ENDNG_DT, '%H:%i') AS dealEndngTime
		FROM 
				TBL_DA_DEAL_M
		WHERE 
				DEAL_SQ = #{dealSq}
	</select>
	
	<select id="selectWork" resultType="hashMap" parameterType="String">
		/* 작품 정보 가져오기 */
		SELECT 
				A.WORK_SQ AS workSq,
				A.WORK_NM AS workNm,
				A.WORK_TYP_CD AS workTypCd,
				A.ARTST_SQ AS artstSq,
				A.ARTST_ACTVTY_NM AS artstActvtyNm,
				A.ARTST_BIRTH_YEAR AS artstBirthYear,
				A.WORK_LAKE AS workLake,
				A.WORK_SIZE_WIDTH AS workSizeWidth,
				A.WORK_SIZE_DEPTH AS workSizeDepth,
				A.WORK_MATRL AS workMatrl,
				A.WORK_PRODC_YEAR AS workProdcYear,
				A.WORK_MAIN_IMG_URL AS workMainImgUrl, /*작품대표이미지주소*/
				A.WORK_IMG_FRT_URL AS workImgFrtUrl,
				A.WORK_IMG_RER_URL AS workImgRerUrl,
				A.WORK_FRM_YN AS workFrmYn,
				A.WORK_SALE_YN AS workSaleYn,
				A.WORK_CLR_CD AS workClrCd,
				A.WORK_GRT_URL AS workGrtUrl,
				FORMAT(A.WORK_PRC, 0) AS workPrc,
				A.WORK_IMG_LEF_URL AS workImgLefUrl,
				A.WORK_IMG_RIT_URL AS workImgRitUrl,
				A.WORK_IMG_TOP_URL AS workImgTopUrl,
				A.WORK_IMG_BOT_URL AS workImgBotUrl,
				A.WORK_VIDEO_URL AS workVideoUrl,
				A.WORK_INTRDC AS workIntrdc,
				(SELECT B.KEYWRD_SQ  
				 FROM TBL_DA_KEYWRD_S AS B
				 WHERE A.WORK_SQ = B.WORK_SQ) AS keywrdSq,
				(SELECT B.KEYWRD
				 FROM TBL_DA_KEYWRD_S AS B
				 WHERE A.WORK_SQ = B.WORK_SQ) AS keywrd
		FROM 
				TBL_DA_WORK_M AS A
				
		WHERE 
				A.WORK_SQ = #{workSq}
	</select>
	
	<select id="selectDealSttsCd" resultType="int" parameterType="hashMap">
		/* 응찰 또는 판매됬는지 확인 */
		SELECT COUNT(*)
		FROM
				(
				SELECT 
						DEAL_SQ AS dealSq
				FROM
						TBL_DA_DEAL_M
				WHERE 
						DEAL_SQ = #{dealSq}
					AND (DEAL_STTS_CD = 'TC' OR DEAL_AUCTN_PRC IS NOT NULL)
				) A
	</select>
	
	<delete id="deleteDeal" parameterType="String">
		/* 거래 중단 */
		DELETE 
		FROM TBL_DA_DEAL_M 
		WHERE DEAL_SQ = #{dealSq}
	</delete>
	
	<select id="selectAuctioneerByMbrSq" resultType="hashMap" parameterType="String">
		/* 거래 종료된 경매 유찰자 조회*/
		SELECT 
				A.MBR_SQ AS mbrSq,
				A.BID_DATE AS bidDate
		FROM 
				(
				SELECT 
						*
				FROM 
						TBL_DA_AUCTN_BID_H
				WHERE 
						DEAL_SQ = #{dealSq}
					AND (BID_DATE) IN (
							SELECT MAX(BID_DATE) AS bidDate
							FROM TBL_DA_AUCTN_BID_H
							GROUP BY MBR_SQ
						)
				ORDER BY BID_DATE
				) A
		WHERE A.MBR_SQ != #{mbrSq}
		GROUP BY A.MBR_SQ
	</select>
</mapper>