<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.da.mapper.MyPageMapper">
	<select id="myDealSearchList" resultType="hashMap" parameterType="hashMap">
	/* 마이페이지 거래내역 리스트 */
		SELECT 
				B.DEAL_SQ AS dealSq,
				B.MBR_SQ AS mbrSq,
				B.WORK_SQ AS workSq,
				B.ARTST_SQ AS artstSq,
				A.WORK_MAIN_IMG_URL AS workMainImgUrl,
				C.ARTST_ACTVTY_NM AS artstActvtyNm,
				C.ARTST_ENGLS_NM AS artstEnglsNm,
				A.WORK_NM AS workNm,
				A.WORK_PRODC_YEAR AS workProdcYear,
				B.DEAL_TYP_CD AS dealTypCd,
				DATE_FORMAT(B.DEAL_STRT_DATE, '%Y.%m.%d') AS dealStrtDate, /*거래시작일시*/
				DATE_FORMAT(B.DEAL_ENDNG_DATE, '%Y.%m.%d') AS dealEndngDate, /*거래종료일시*/
				B.DEAL_STRT_PRC AS dealStrtPrc,
				E.MAX_BID_PRC AS maxBidPrc,
				DATEDIFF(B.DEAL_ENDNG_DATE, NOW()) AS dealRemainingDay, /*거래남은일자*/
				DATE_FORMAT(TIMEDIFF(DATE_FORMAT(B.DEAL_ENDNG_DATE, '%H:%i:%s'), DATE_FORMAT(NOW(), '%H:%i:%s')), '%H') AS dealRemainingHour, /*거래남은시*/
				DATE_FORMAT(TIMEDIFF(DATE_FORMAT(B.DEAL_ENDNG_DATE, '%H:%i:%s'), DATE_FORMAT(NOW(), '%H:%i:%s')), '%i') AS dealRemainingMin, /*거래남은분*/
				DATE_FORMAT(TIMEDIFF(DATE_FORMAT(B.DEAL_ENDNG_DATE, '%H:%i:%s'), DATE_FORMAT(NOW(), '%H:%i:%s')), '%s') AS dealRemainingSec, /*거래남은초*/
				D.BID_CNT AS bidCnt,
				G.MAX_BID_DATE AS maxBidDate
		FROM 
				TBL_DA_WORK_M AS A,
				TBL_DA_DEAL_M AS B, 
				TBL_DA_ARTST_M AS C,
				(
					SELECT 
							DEAL_SQ , COUNT(DEAL_SQ) AS BID_CNT
					FROM 
							TBL_DA_AUCTN_BID_H 
					GROUP BY DEAL_SQ 
					ORDER BY BID_CNT DESC
				) AS D, /* 작품 응찰 횟수 */
				(
					SELECT 
							DEAL_SQ, MAX(BID_PRC) AS MAX_BID_PRC
					FROM 
							TBL_DA_AUCTN_BID_H
					GROUP BY DEAL_SQ
				) AS E, /* 작품 최고 응찰금액 */
				TBL_DA_AUCTN_BID_H AS F,
				(
					SELECT 
							DEAL_SQ, MAX(DATE_FORMAT(BID_DATE, '%Y.%m.%d')) AS MAX_BID_DATE
					FROM 
							TBL_DA_AUCTN_BID_H
					GROUP BY DEAL_SQ
				) AS G  /* 작품 마지막 응찰 일시 */
		WHERE 
				A.WORK_SQ = B.WORK_SQ 
			AND	A.ARTST_SQ = B.ARTST_SQ 
			AND A.MBR_SQ = B.MBR_SQ 
			AND C.MBR_SQ = B.MBR_SQ 
			AND D.DEAL_SQ = B.DEAL_SQ 
			AND E.DEAL_SQ = B.DEAL_SQ 
			AND F.DEAL_SQ = B.DEAL_SQ 
			AND G.DEAL_SQ = B.DEAL_SQ
			AND F.MBR_SQ = #{mbrSq}
			<if test="searchKeyword != null and searchKeyword != ''">
				AND (
						MATCH (C.ARTST_ACTVTY_NM) AGAINST (#{searchKeyword} IN BOOLEAN MODE)
						OR MATCH (C.ARTST_ENGLS_NM) AGAINST (#{searchKeyword} IN BOOLEAN MODE)
						OR MATCH (A.WORK_NM) AGAINST (#{searchKeyword} IN BOOLEAN MODE)
					)
			</if>
			<if test="searchStrtDate != null and searchStrtDate != '' and searchEndngDate != null and searchEndngDate != ''">
				AND G.MAX_BID_DATE BETWEEN #{searchStrtDate} AND #{searchEndngDate}
			</if>
		GROUP BY F.DEAL_SQ;
	</select>
	
</mapper>